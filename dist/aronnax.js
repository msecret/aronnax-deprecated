// Copyright (c) 2013
// All Rights Reserved
// https://github.com/msecret/aronnax
// Licensed MIT

// http://paulirish.com/2011/requestanimationframe-for-smart-animating/
// http://my.opera.com/emoller/blog/2011/12/20/requestanimationframe-for-smart-er-animating
// requestAnimationFrame polyfill by Erik MÃ¶ller. fixes from Paul Irish and Tino Zijdel
// MIT license

(function(){define("aronnax/base",["underscore"],function(e){"use strict";function r(e){return n[e]||(n[e]=0),n[e]++}var t=0,n={},i={create:function(e,t,n){var r=Object.create(e),i,s;Object.defineProperty(r,"className",{value:t||"Base",configurable:!1,enumerable:!1,writable:!1});for(s in n)n.hasOwnProperty(s)&&(i=n[s],typeof i=="function"?r[s]=i:Object.defineProperty(r,s,i));return r},construct:function(e){var n=r(e.className),i=Object.create(e,{id:{enumerable:!1,writable:!1,value:t++},classId:{enumerable:!1,writable:!1,value:n}});return i}};return i}),define("aronnax/config",[],function(){"use strict";var e={env:"dev",initialPoolSizeAmount:12,fps:60};return e}),define("deps/logWriter",[],function(){return window.console}),define("aronnax/deps/logWriter",function(){}),define("aronnax/logger",["underscore","aronnax/base","aronnax/config","aronnax/deps/logWriter"],function(e,t,n,r){"use strict";var i=t.create(Object.prototype,"Log",{init:function(e,t){this.name=e||window.location.hostname,this._logWriter=t,s.logs.push(this)},log:function(e){this._write("log",e)},warn:function(e){this._write("warn",e)},error:function(e){this._write("error",e)},_write:function(t,n){var r={};r.type=t,typeof n=="string"?r.message=n:e.extend(r,n);switch(s.settings.environment){case"staging":this._logWriter[t](this.name+":"+r.message);break;case"production":break;default:this._logWriter[t](this.name+":"+r.message)}}}),s={logs:[],settings:{environment:n.env,errorTypes:["log","warn","error"]},getLog:function(e){var n=0,s=this.logs.length,o;for(;n<s;n++){o=this.logs[n];if(o.name===e)return o}return o=t.create(i),o.init(e,r),o}};return s}),define("aronnax/util",["underscore","aronnax/config","aronnax/logger"],function(e,t,n){"use strict";function i(e){e.length=0}function s(e){var t;for(t in e)if(e.hasOwnProperty(t))try{delete e[t]}catch(n){}}var r=n.getLog("aronnax.util"),o={cleanAnything:function(t){return e.isArray(t)?i(t):e.isObject(t)&&s(t),t}};return o}),define("aronnax/shims/requestAnimationFrame",[],function(){return function(){var e=0,t=["ms","moz","webkit","o"];for(var n=0;n<t.length&&!window.requestAnimationFrame;++n)window.requestAnimationFrame=window[t[n]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[n]+"CancelAnimationFrame"]||window[t[n]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t,n){var r=(new Date).getTime(),i=Math.max(0,16-(r-e)),s=window.setTimeout(function(){t(r+i)},i);return e=r+i,s}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),window.requestAnimationFrame}),define("aronnax/core",["aronnax/base","aronnax/logger","aronnax/util","aronnax/config","aronnax/shims/requestAnimationFrame"],function(e,t,n,r,i){"use strict";var s=t.getLog("aronnax.Core"),o=r.fps||60,u=1e3/o,a=!1,f,l=e.create(Object.prototype,"Core",{fps:{get:function(){return o},set:function(e){o=e,u=1e3/o}},millisecondsPerFrame:{get:function(){return u}},previousTime:{writable:!0},lag:{writable:!0},frame:{value:0,writable:!0},isRunning:{get:function(){return a}},requestId:{get:function(){return f}},tick:function(){var e=(new Date).getTime(),t;t=e-this.previousTime,this.previousTime=e,this.lag+=t;while(this.lag>=u)this.update(),this.lag-=u;this.draw(this.lag/u),this.frame++},run:function(){a||(this.launchLoop(),a=!0)},launchLoop:function(){var e,t=this;this.previousTime=(new Date).getTime(),this.lag=0,e=function(){t.tick(),a&&(f=i(e))},e()},stop:function(){a=!1},update:function(){s.log("update"),this.frame>100&&this.stop()},draw:function(){s.log("draw")}});return l}),define("aronnax/store",["underscore","aronnax/base"],function(e,t){function n(t){return e.isArray(t)?t.join("*"):e.isFunction(t)?t.toString():e.isObject(t)?JSON.stringify(t):t.toString()}var r=t.create(Object.prototype,"Store",{store:{get:function(){return this._dataStore}},length:{get:function(){return e.size(this._dataStore)}},init:function(){this._dataStore={}},put:function(e){var t;if(e.classId){if(this._dataStore[e.classId])throw new Error("Object key collision occurred, cannot store key");this._dataStore[e.classId]=e}else if(e.id){if(this._dataStore[e.id])throw new Error("Object key collision occurred, cannot store key");this._dataStore[e.id]=e}else t=this.stringify(e),this._dataStore[t]||(this._dataStore[t]=[]),this._dataStore[t].push(e);return e},get:function(e){var t;if(e.classId)return this._dataStore[e.classId];if(e.id)return this._dataStore[e.id];t=this.stringify(e);if(!this._dataStore[t])return;return this._dataStore[t][0]},stringify:function(e){return n(e)},remove:function(e){var t=this.get(e),n;if(t)return e.classId&&delete this._dataStore[e.classId],e.id?(delete this._dataStore[e.id],t):(n=this.stringify(e),this._dataStore[n].pop())}});return r}),define("aronnax/pool",["aronnax/base","aronnax/logger","aronnax/util","aronnax/config","aronnax/store"],function(e,t,n,r,i){"use strict";function o(t){var n;switch(t){case"array":n=[];break;case"function":n=function(){};break;case"Base":case"object":n={};break;default:n=e.construct(this.basePrototype)}return n}var s=t.getLog("aronnax.Pool"),u=e.create(Object.prototype,"Pool",{activePool:{writable:!0},freePool:{writable:!0},totalObjectsFree:{get:function(){return this.freePool.length}},totalObjectsActive:{get:function(){return this.activePool.length}},init:function(e,t,n){this.freePool=[],this.activePool=Object.create(i),this.activePool.init(),this.basePrototype=t,this.expandPool(e)},expandPool:function(e){var t=0,n=e||r.initialPoolSizeAmount;for(;t<n;t++){var i=o.call(this,this.className);this.freePool.push(i)}},acquireMember:function(){this.freePool.length<=0&&this.expandPool();var e=this.freePool.pop();return this.activePool.put(e),e},releaseMember:function(e){var t=this.activePool.get(e),r;if(!t)throw new Error("Member not found, cannot be released");r=this.activePool.remove(e),n.cleanAnything(r),this.freePool.push(r)}}),a={pools:{},totalPools:0,get totalActiveObjects(){var e=0,t,n;for(t in this.pools)n=this.pools[t],e+=n.totalObjectsActive;return e},get totalFreeObjects(){var e=0,t,n;for(t in this.pools)n=this.pools[t],e+=n.totalObjectsFree;return e},acquirePool:function(e,t){var n=this.getPool(t,e);return n||(n=this.createPool(e,t)),n},getPool:function(e,t){var n=t||this.getClassName(e);return this.pools[n]},getClassName:function(e){var t=e.className;if(typeof t!="string")if(window.toString.call(e)==="[object Array]")t="array";else if(typeof e=="function")t="function";else{if(typeof e!="object")throw s.error("Aquired Pool class not a string"),new Error("Aquired Pool class not a string");t="object"}return t},acquire:function(e){var t,n;try{t=this.getClassName(e)}catch(r){throw new Error(r)}return n=this.acquirePool(t,e),n.acquireMember()},release:function(e){var t=this.getClassName(e),n=this.acquirePool(t);n&&n.releaseMember(e)},createPool:function(e,t,n){var r=Object.create(u);return Object.defineProperty(r,"className",{value:e}),r.init(n,t,e),this.totalPools+=1,this.pools[e]=r,r}};return a}),define("aronnax/pooled",["aronnax/base","aronnax/pool"],function(e,t){var n=e.create(Object.prototype,"Pooled",{make:function(){var e=t.acquire(this),n;return e},free:function(){return t.release(this),undefined},pool:{get:function(){var e=t.getPool(this);return e}}});return n}),define("aronnax/entity",["underscore","aronnax/base","aronnax/logger","aronnax/config","aronnax/pooled"],function(e,t,n,r,i){var s=t.create(i,"Entity",{components:{value:{},writable:!0},componentList:{value:[],writable:!0},init:function(e){console.log("EntityProto.init"),this.initComponents(e)},initComponents:function(e){var n,r;for(n in this.components)this.components.hasOwnProperty(n)&&(r=this.components[n],this[r.className]=t.construct(r),this[r.className].init(e))},addMixins:function(t){e.extend(this,t)}}),o=t.create(s,"Entity",{create:function(e,n){var r=t.create(s,e),i,o=0,u;r.components={},r.componentList=[];if(n)for(u=n.length;o<u;o++)i=n[o],r[i.className]=i,r.components[i.className]=i,r.componentList.push(i.className);return r},addMixins:function(t,n){e.extend(t,n)}});return o}),require(["aronnax/base","aronnax/core","aronnax/pooled","aronnax/entity"],function(e,t,n,r){}),define("aronnax/aronnax",function(){})})();